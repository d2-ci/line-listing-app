"use strict";(self.webpackChunkline_listing_app=self.webpackChunkline_listing_app||[]).push([[2143],{2127:(e,t,a)=>{a.r(t),a.d(t,{default:()=>Ve});var n=a(696),i=a(8594),r=a(4479),l=a(6329),s=a(3665),o=a.n(s),d=a(2085),c=a(1475),u=a(9551),p=a(2703),m=a(4584),g=a(9308),v=a(9500),f=a(5215),y=a(1250),h=a(9647),E=a(4991),S=a(1949),z=a(101),_=a(2305),w=a(6206),D=a.n(w);var b=a(5633),T=a(9941),C=a.n(T),P=a(5133);new Set([P.P6,P.qI,P.xi,P.PH,P.M6]),new Set([P.zC]);const V="programStatus",N="eventStatus",I="createdBy",k="lastUpdatedBy",x="eventDate",L="enrollmentDate",R="incidentDate",M="scheduledDate",O="lastUpdated",A=new Set([x,L,R,M,O]);var Z=a(4805),q=a(1517),F=a(2644);const U="COMPLETED",H="EVENT",Q="ENROLLMENT",$={[Z.rx]:"ouname",[V]:"programstatus",[N]:"eventstatus",[I]:"createdbydisplayname",[k]:"lastupdatedbydisplayname",[x]:"eventdate",[L]:"enrollmentdate",[R]:"incidentdate",[M]:"scheduleddate",[O]:"lastupdated"},j={[H]:x,[Q]:L},W=(e,t)=>{let{outputType:a,type:n}=t;return e.filter((e=>!["longitude","latitude"].includes(e.dimension))).map((e=>e.dimensionType===P.cl?{...e,dimensionType:P.P6}:e.dimension===Z.vi&&n===F.UU?{...e,dimension:j[a],dimensionType:P.KV}:e))},B=(F.UU,F.Zp,e=>{let{value:t,header:a={},visualization:n={}}=e;return[$.eventStatus,$.programStatus].includes(a.name)?{ACTIVE:m.Z.t("Active"),CANCELLED:m.Z.t("Cancelled"),[U]:m.Z.t("Completed"),SCHEDULE:m.Z.t("Scheduled")}[t]||t:[c.$d,c.Wt].includes(a.valueType)?t&&C()(t).format(a.name===$.lastUpdated||a.valueType===c.Wt?"yyyy-MM-DD hh:mm":"yyyy-MM-DD"):(null==a?void 0:a.valueType)===c.H?t&&C()(t).format("yyyy-MM-DD"):(0,b.Q)(t,a.valueType||c.kl,a.optionSet?{}:{digitGroupSeparator:n.digitGroupSeparator,skipRounding:!1})}),J=function(){let{stageOffset:e,column:t}=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(!t)return"";if(Number.isInteger(e)){let a;return 0===e?a=m.Z.t("most recent"):1===e?a=m.Z.t("oldest"):e>1?a=m.Z.t("oldest {{repeatEventIndex}}",{repeatEventIndex:"+"+(e-1)}):e<0&&(a=m.Z.t("most recent {{repeatEventIndex}}",{repeatEventIndex:e})),`${t} (${a})`}return t},G="Visualization_legendKeyScrollbox__xeUwY",K="Visualization_pluginContainer__oXPo4",X="Visualization_fetchIndicator__I2E9y",Y="Visualization_fetching__7HD9F",ee="Visualization_stickyFooter__Dd34A",te="Visualization_footerCell__Fncu5",ae="Visualization_stickyNavigation__0J6KV",ne="Visualization_dataTable__5lDA5",ie="Visualization_headerCell__4qkrt",re="Visualization_dimensionModalHandler__yWmOU",le="Visualization_fontSizeLarge__z2BH2",se="Visualization_fontSizeNormal__jf7Sh",oe="Visualization_fontSizeSmall__FfsnC",de="Visualization_sizeComfortable__Su+7Q",ce="Visualization_sizeNormal__gHiph",ue="Visualization_sizeCompact__8D9I5",pe="Visualization_cell__6WA8H",me="Visualization_emptyCell__5ufEQ";var ge=a(3100);const ve="NV",fe=()=>({1:m.Z.t("Yes"),0:m.Z.t("No"),[ve]:m.Z.t("Not answered")}),ye={[Q]:"enrollments",[H]:"events"},he=[I,k],Ee=(e,t,a)=>{var n,i;switch(t.valueType){case c.zU:case c.mb:return fe()[e||ve];default:return t.optionSet?(null===(n=((e,t)=>Object.values(t).find((t=>t.code===e)))(e,a))||void 0===n?void 0:n.name)||e:(null===(i=a[e])||void 0===i?void 0:i.name)||e}},Se=e=>{const t={},a=e=>{const a=[];return e.forEach((e=>{const n=e.dimension;var i,r;(e=>A.has(e))(n)||n===N||n===V?null!==(i=e.items)&&void 0!==i&&i.length&&(t[n]=null===(r=e.items)||void 0===r?void 0:r.map((e=>e.id))):he.includes(n)||a.push(e)})),a},n=a(e[q.Aq]),i=a(e[q.dQ]),r=a(e[q.lT]),l=[...e[q.Aq],...e[q.dQ]].map((e=>{var t;let{dimension:a,programStage:n,repetition:i}=e;const r=null!=n&&n.id?`${n.id}.${a}`:$[a]||a;return null!=i&&null!==(t=i.indexes)&&void 0!==t&&t.length?i.indexes.map((e=>r.replace(/\./,`[${e}].`))):r}));return{adaptedVisualization:{[q.Aq]:n,[q.dQ]:i,[q.lT]:r},headers:l,parameters:t}},ze=async e=>{let{analyticsEngine:t,visualization:a,pageSize:n,page:i,relativePeriodDate:r,sortField:l,sortDirection:s,displayProperty:o}=e;const{adaptedVisualization:d,headers:c,parameters:u}=Se(a);let p=(new t.request).fromVisualization(d).withParameters({headers:c,totalPages:!1,...u}).withProgram(a.program.id).withDisplayProperty(o.toUpperCase()).withOutputType(a.outputType).withPageSize(n).withPage(i).withIncludeMetadataDetails();var m;a.outputType!==Q&&(p=p.withStage(null===(m=a.programStage)||void 0===m?void 0:m.id));if(r&&(p=p.withRelativePeriodDate(r)),l)switch(s){case"asc":p=p.withAsc(l);break;case"desc":p=p.withDesc(l)}const g=(v=a.outputType,ye[v]);var v;return await t[g].getQuery(p)},_e={resource:"legendSets",params:e=>{let{ids:t}=e;return{fields:"id,displayName~rename(name),legends[id,displayName~rename(name),startValue,endValue,color]",filter:`id:in:[${t.join(",")}]`}}},we=async e=>{let{legendSetIds:t,dataEngine:a}=e;if(!t.length)return[];const n=await(async e=>{let{dataEngine:t,ids:a}=e;return(await t.query({legendSets:_e},{variables:{ids:a}})).legendSets.legendSets})({dataEngine:a,ids:t});return n},De=e=>{let{visualization:t,filters:a,isVisualizationLoading:i,displayProperty:r,onResponsesReceived:l,pageSize:s,page:o,sortField:u,sortDirection:m}=e;const g=(0,n.bQ)(),[v]=(0,d.useState)((()=>ge.Z.getAnalytics(g))),f=(0,d.useRef)(!1),[y,h]=(0,d.useState)(!0),[E,S]=(0,d.useState)(!0),[z,_]=(0,d.useState)(void 0),[w,D]=(0,d.useState)(null),b=null==a?void 0:a.relativePeriodDate,T=(0,d.useCallback)((async()=>{try{var e,a,n,i;const d=await ze({analyticsEngine:v,page:o,pageSize:s,relativePeriodDate:b,sortDirection:m,sortField:u,visualization:t,displayProperty:r}),y=(e=>e.headers.map(((t,a)=>{const n={...t,index:a},{dimensionId:i,programStageId:r}=(e=>{const[t,a]=e.split(".").reverse(),[n,i]=(a||"").split("[");return{dimensionId:t,programStageId:n,repetitionIndex:(null==i?void 0:i.length)&&i.substring(0,i.indexOf("]"))}})(t.name);return r&&e.headers.filter((e=>e.name.includes(i))).length>1&&(n.column+=` - ${e.metaData.items[r].name}`),n})))(d),E=((e,t)=>{const a=[];for(let n=0,i=e.rows.length;n<i;n++){const i=e.rows[n],r=[];for(let a=0,n=t.length;a<n;a++){const n=t[a],l=i[n.index];r.push(Ee(l,n,e.metaData.items))}a.push(r)}return a})(d,y),z=d.metaData.pager,w=[],T=y.reduce(((e,t)=>{var a;return{...e,[t.name]:null===(a=d.metaData.items[t.name])||void 0===a?void 0:a.legendSet}}),{});(null===(e=t.legend)||void 0===e?void 0:e.strategy)===p.zv&&null!==(a=t.legend)&&void 0!==a&&null!==(n=a.set)&&void 0!==n&&n.id?w.push(t.legend.set.id):(null===(i=t.legend)||void 0===i?void 0:i.strategy)===p.EE&&Object.values(T).filter((e=>e)).forEach((e=>w.push(e)));const C=await we({legendSetIds:w,dataEngine:g});C.length&&y.filter((e=>{return t=e.valueType,[c.FV,c.SA,c.y3,c.$r,c.VX,c.M7,c.iq].includes(t);var t})).forEach((e=>{switch(t.legend.strategy){case p.zv:e.legendSet=C[0];break;case p.EE:e.legendSet=C.find((t=>t.id===T[e.name]))}})),f.current&&_(void 0),f.current&&D({headers:y,rows:E,pager:z}),l(d)}catch(e){f.current&&_(e)}finally{f.current&&h(!1),f.current&&S(!1)}}),[v,o,s,b,m,u,t]);return(0,d.useEffect)((()=>(f.current=!0,()=>{f.current=!1})),[]),(0,d.useEffect)((()=>{S(!0),T()}),[t,o,s,u,m,b]),(0,d.useEffect)((()=>{i&&(S(!1),h(!1),_(void 0),D(null))}),[i]),{loading:y,fetching:E,error:z,data:w,isGlobalLoading:i}},be=e=>{let{offline:t,...a}=e;return t?d.createElement(g.u,{content:m.Z.t("Not available offline")},d.createElement(v.t,a)):d.createElement(v.t,a)};be.propTypes={offline:o().bool};const Te=e=>{let{filters:t,visualization:a,isVisualizationLoading:i,displayProperty:r,onResponsesReceived:l,onColumnHeaderClick:s,onError:o}=e;const[g,v]=(0,d.useState)([]),[{sortField:w,sortDirection:b,pageSize:T,page:C},P]=(0,d.useState)({sortField:null,sortDirection:"asc",page:1,pageSize:100}),{offline:V}=(0,n.kr)(),I=!(null==t||!t.relativePeriodDate),k=(0,d.useMemo)((()=>a&&(e=>{const t=W(e[q.Aq],e),a=W(e[q.dQ],e),n=W(e[q.lT],e);e.completedOnly&&e.outputType===H&&n.push({dimension:N,items:[{id:U}]});const i={...e};return delete i.completedOnly,{...i,[q.Aq]:t,[q.dQ]:a,[q.lT]:n}})(a)),[a]),{fetching:x,error:L,data:R}=De({filters:t,visualization:k,isVisualizationLoading:i,displayProperty:r,onResponsesReceived:l,pageSize:T,page:C,sortField:w,sortDirection:b});if((0,d.useEffect)((()=>{if(R&&k){var e;const t=R.headers.filter((e=>e.legendSet)).map((e=>e.legendSet)),a=t.filter(((e,a)=>{var n;return t.findIndex((t=>t.id===e.id))===a&&(null===(n=e.legends)||void 0===n?void 0:n.length)}));a.length&&null!==(e=k.legend)&&void 0!==e&&e.showKey?v(a):v([])}else v([])}),[R,k]),(0,d.useEffect)((()=>{L&&o&&o(L)}),[L,o]),!R||L)return null;const M=(e=>{switch(e){case"COMFORTABLE":return de;case"COMPACT":return ue;default:return ce}})(k.displayDensity),O=(e=>{switch(e){case"LARGE":return le;case"SMALL":return oe;default:return se}})(k.fontSize),A=String(Math.max(R.headers.length,1)),Z=e=>{let{name:t,direction:a}=e;return P({sortField:t,sortDirection:a,pageSize:T,page:1})},F=e=>{const t=J(e),a=Number.isInteger(e.stageOffset)?e.name.replace(/\[-?\d+\]/,""):e.name;return d.createElement("span",{className:D()(ie,re),onClick:s?()=>s((e=>Object.keys($).find((t=>$[t]===e)))(a)||a):void 0},t)};return d.createElement("div",{className:K},d.createElement("div",{className:D()(X,{[Y]:x})},d.createElement(f.w,{scrollHeight:I?"calc(100vh - 285px)":"100%",scrollWidth:"100%",width:"auto",className:ne,dataTest:"line-list-table"},d.createElement(y.s,null,d.createElement(h.U,null,R.headers.map(((e,t)=>e?d.createElement(E.p,{fixed:!0,top:"0",key:e.name,name:e.name,onSortIconClick:Z,sortDirection:V?void 0:e.name===w?b:"default",sortIconTitle:m.Z.t("Sort by {{column}}",{column:J(e)}),className:D()(ie,O,M,"bordered"),dataTest:"table-header"},F(e)):d.createElement(E.p,{fixed:!0,top:"0",key:`undefined_${t}`,className:D()(ie,O,M),dataTest:"table-header"}))))),d.createElement(S.R,{dataTest:"table-body"},R.rows.map(((e,t)=>d.createElement(h.U,{key:t,dataTest:"table-row"},e.map(((e,t)=>{var a,n;return d.createElement(z.W,{key:t,className:D()(pe,O,M,{[me]:!e},"bordered"),backgroundColor:(null===(a=k.legend)||void 0===a?void 0:a.style)===p.UJ?(0,p.i3)(R.headers[t].legendSet,e):void 0,dataTest:"table-cell"},d.createElement("div",{style:(null===(n=k.legend)||void 0===n?void 0:n.style)===p.Xr?{color:(0,p.i3)(R.headers[t].legendSet,e)}:{}},((e,t)=>(null==t?void 0:t.valueType)===c.Xw?d.createElement("a",{href:e,target:"_blank",rel:"noreferrer"},e):B({value:e,header:t,visualization:k}))(e,R.headers[t])))})))))),d.createElement(_.j,{className:ee},d.createElement(h.U,null,d.createElement(z.W,{colSpan:A,staticStyle:!0,className:te},d.createElement("div",{className:D()(ae,M)},d.createElement(be,{offline:V,disabled:V||x,page:R.pager.page,pageSize:R.pager.pageSize||100,isLastPage:R.pager.isLastPage,onPageChange:e=>P({sortField:w,sortDirection:b,pageSize:T,page:e}),onPageSizeChange:e=>P({sortField:w,sortDirection:b,pageSize:e,page:1}),pageSizeSelectText:m.Z.t("Rows per page"),pageLength:R.rows.length,pageSummaryText:e=>{let{firstItem:t,lastItem:a,page:n}=e;return m.Z.t("Page {{page}}, row {{firstItem}}-{{lastItem}}",{firstItem:t,lastItem:a,page:n})}}))))))),Boolean(g.length)&&d.createElement("div",{className:G,"data-test":"visualization-legend-key"},d.createElement(u.Z,{legendSets:g})))};Te.defaultProps={displayProperty:"name",isVisualizationLoading:!1,onResponsesReceived:Function.prototype},Te.propTypes={displayProperty:o().string.isRequired,isVisualizationLoading:o().bool.isRequired,visualization:o().object.isRequired,onResponsesReceived:o().func.isRequired,filters:o().object,onColumnHeaderClick:o().func,onError:o().func};const Ce=()=>d.createElement(i.m,null,d.createElement(r.M,null,d.createElement(l.V,null))),Pe=e=>{let{id:t,children:a,cacheNow:i,isParentCached:r}=e;const{startRecording:l,isCached:s,remove:o}=(0,n.Of)(t);return(0,d.useEffect)((()=>{i&&l({onError:console.error})}),[i]),(0,d.useEffect)((()=>{!r&&s&&o()}),[r]),d.createElement(n.MW,{id:t,loadingMask:Ce},a)};Pe.propTypes={cacheNow:o().bool,children:o().node,id:o().string,isParentCached:o().bool};const Ve=()=>{const[e,t]=(0,d.useState)();return(0,d.useEffect)((()=>{const e=e=>{let a;console.log("message received in iframe via channel",e);try{a=JSON.parse(e.data)}catch(e){console.log("Event data is not a serialised JSON object")}if("DHIS2"===a.type)switch(a.command){case"removeCachedData":console.log("removeCachedData not implemented");break;case"sendProps":t(a.payload)}};return window.addEventListener("message",(t=>{console.log("message received in iframe",t),"sendPort"===t.data&&t.ports&&t.ports.length&&(t.ports[0].onmessage=e,t.ports[0].postMessage(JSON.stringify({type:"DHIS2",command:"requestProps"})))})),window.parent.postMessage("requestPort","*"),()=>window.removeEventListener("message",e)}),[]),d.createElement("div",null,e?d.createElement("div",{style:{display:"flex",height:"100%",overflow:"hidden"}},d.createElement(Pe,{id:e.cacheId,cacheNow:e.recordOnNextLoad,isParentCached:e.isParentCached},d.createElement(Te,e))):null)}}}]);